package com.tencent.djcity.util;

import android.app.Application;
import android.content.Context;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager.NameNotFoundException;

import com.tencent.djcity.lib.AppStorage;
import com.tencent.djcity.lib.UExceptionHandler;
import com.tencent.djcity.lib.ui.UiUtils;
import com.tencent.djcity.util.db.DbFactory;

public class IcsonApplication extends Application {
	private static final String LOG_TAG =  IcsonApplication.class.getName();
	public static AppStorage mStorage = null;
	public static IcsonApplication app;
	public static boolean APP_RUNNING = false;
	public static int mVersionCode;
	public static String mReportTag = "";  //??¨å??tagï¼???¨ä????°æ??ä¸????
	
	@Override
	public void onCreate() {
		super.onCreate();
		IcsonApplication.app = this;
		
		//CrashReport.initCrashReport(this);
		//String userId = ILogin.getLoginUid() + ""; // ??¨æ??ID
		//CrashReport.setUserId(this, userId);
		
//		if (Config.DEBUG) // æ­£å?????å¸???¶è?°å??è¦???³é??
//        {
//			CrashReport.setLogAble(true, false);
//        }
		
		//setExceptionStrategy();

		/*
		if (Config.DEBUG) // æ­£å?????å¸???¶è?°å??è¦???³é??
        {
             Constants.IS_DEBUG = true; // è¾????eup log
             Constants.IS_CORE_DEBUG = true; // è¾???ºæ?´è??ç»???? eup log
             Constants.IS_USETESTSERVER = true; // ä½¿ç?¨æ??è¯??????¡å??ï¼???¿å??æ±¡æ??æ­£å?????å¢?

             // ???å§???¥å?¥æ??SDKå¦?????????°ä½¿??¨é??é¢???¶ï??ä¼??????ºå??å¸¸ï??SDK??¥å?¥æ?¶å»ºè®?å¼????ï¼????ä»¥é?¿å??ä½¿ç?¨ä???????ºé?????
             Constants.Is_AutoCheckOpen = true;
        }
		
		String userId = ILogin.getLoginUid()+""; // ???ä¸????è¯?ä¸?ä¸???¨æ??
        //SDKä¸???¥æ?¶é?½æ?????UploadHandlerä¸????doUpload??¹æ??ï¼???¨æ?·å??ä»¥æ?¹æ?????å·±ç?????è¦?å®???°è??å·±ç??ä¸???¥å?¨è??????????§æ????§å?¶æ????????SDKä¸???¥ï??
        //SDK???é»?è®¤å????°å??ä»¥é??è¿?Analytics.getDefaultUpload(this)??·å?????
         UploadHandler hanlder = ExceptionUpload.getDefaultUpload(this);

         // ??????æ¯?æ¬¡ä????¥ç????????MonitorUploadHandler
         // hanlder =createMonitorUploadHandler(this);
         
          // APPä½¿ç?¨ä??Eup ??? Eup_Gray???jar???ï¼?
           //???å§????1ï¼?
          ExceptionUpload eup = ExceptionUpload.getInstance(this, userId, true, hanlder); //é»?è®¤ä??å¼????å¼?å¸¸å??å¹¶å?????
          
           //???å§????2ï¼?
          // ExceptionUpload eup = ExceptionUpload.getInstance(this, userId, isStartAfterQuery, hanlder,true); //å¼????å¼?å¸¸å??å¹¶å?????

          // ???ç½?å¼?å¸¸ä????¥ï??æ³¨æ?????ç½????è¦???¨å????????ï¼????????????½æ??æ³??????¶ç?????
          setExceptionUpload();

          // ???ç½?å¼?å¸¸ä????¥ï??æ³¨æ?????ç½????è¦???¨å????????ï¼????????????½æ??æ³??????¶ç?????
          eup.setIsUseEup(true);
          */
		
	}
	
	

//	private void setExceptionUpload() {
//		/* isDefaultEup trueè¡¨ç¤ºå¼?å¸¸ä????¥æ?¶ä???????¥ç?¨æ?·ç?´æ?¥é??é»?ä¸???¥ï??false???ä¼?å¼¹æ??????????¨æ?·ç?±ç?¨æ?·é????©æ?????ä¸???¥ã?? */
//        ExceptionUpload.setDefaultEUP(true);
//
//        /* ?????¨æ?·å???????½å?¨å?????å¼?å¸¸æ?¶ï?????ä¸?äº?å¤????ï¼????ä»¥é??è¿?è¿?ä¸???¥å?£è?¾ç½® */
//        ExceptionUpload.setYourUncaughtExceptionHandler(new UncaughtExceptionHandler()
//        {
//
//             @Override
//             public void uncaughtException(Thread thread, Throwable ex)
//             {
//                  // å¤???????????????????
//                  // ???ä¸?æ¬¡å??å¸¸å???????§ã????????
//                  ex.printStackTrace();
//             }
//        });
//
//        /*
//        * ???äº???¨æ?·å???????½æ??å¼?å¸¸å??????????????ä¿¡æ????½å????¨å?¨ç?¨æ?·ç??sdcardä¸?ï¼???¹ä¾¿å¯¹æ?¹æ??è¯???¶ç?´æ?¥å????¨æ?·è?·å??ï¼? å¦????ä½????è¿?ä¸????æ±?ï¼???????è¦?å¦?ä¸????ä½?ï¼?
//        * isStoreEupLogSdcard = true,
//        * å¹¶ç¡®ä¿????å·±ç??åº???¨å?·æ??æ­¤æ?????ï¼?android.permission.WRITE_EXTERNAL_STORAGE
//        * å¼?å¸¸ç????????å°?ä¼??????¥æ??é¡ºå??ä¿?å­????sdcardä¸?ï¼?å¹¶ä??è®¾ç½®äº????ä»¶å¤§å°??????¶ï??ä¸?ä¼?å¯¼è?´æ??ä»¶ä?????å¢?å¤§ã??
//        */
//        Constants.isStoreEupLogSdcard = true;
//	}

	public static void start() {
		if (APP_RUNNING == true) {
			return;
		}
		
		APP_RUNNING = true;

		try {
			UExceptionHandler UEHandler = new UExceptionHandler();
			Thread.setDefaultUncaughtExceptionHandler(UEHandler);
		} catch (SecurityException ex) {
			android.util.Log.e(LOG_TAG, "onCreate|" + ex.getMessage());
		}

		
		// Retrieve the version code.
		Context pContext = IcsonApplication.app.getApplicationContext();
		IcsonApplication.getVersionCode(pContext);
		
		
		// Create new instance of AppStorage
		mStorage = new AppStorage(pContext);
		
		
		mReportTag = "";
		
	}
	
	public static void getVersionCode(Context aContext) {
		if( (mVersionCode > 0) || (null == aContext) )
			return ;
		
		PackageInfo pInfo = null;
		try 
		{
			pInfo = aContext.getApplicationContext().getPackageManager().getPackageInfo(aContext.getApplicationContext().getPackageName(), 0);
		}
		catch (NameNotFoundException e) 
		{
			e.printStackTrace();
			pInfo = null;
		}
		mVersionCode = (null != pInfo ? pInfo.versionCode : 0);
	}

	public static void exit() {
		APP_RUNNING = false;
		
		if( null != mStorage ) {
			mStorage.save();
			mStorage = null;
		}
		
		
		DbFactory.closeDataBase();
		
		
		//clear static stuff
		UiUtils.clear();
		
		mReportTag = "";
				
		//ReloginWatcher.clear();
				
		//FullDistrictHelper.clear();
	}

	@Override
	public void onTerminate() {
		super.onTerminate();
		DbFactory.closeDataBase();
		
		
	}
	
}
